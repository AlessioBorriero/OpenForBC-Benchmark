from user_interfaces.utils import getSettings
from common.benchmark_wrapper import BenchmarkWrapper
import json
import urllib.request as urllib
import subprocess
import tarfile
import platform
import os
import zipfile


class BlenderBenchmark(BenchmarkWrapper):

    """
    This is a Blender benchmark implementation.
    """

    def __init__(self):
        self._settings = {}
        self.filePath = os.path.dirname(__file__)
        self.baseCommand = "benchmark-launcher-cli"
        self.system = platform.system().lower()
        if self.system == "linux":
            self.url = "https://download.blender.org/release/BlenderBenchmark2.0/launcher/benchmark-launcher-cli-2.0.5-linux.tar.gz"
        else:
            self.url = f"https://download.blender.org/release/BlenderBenchmark2.0/launcher/benchmark-launcher-cli-2.0.4-{self.system}.zip"
        if not os.path.isfile(os.path.join(self.filePath, "benchmark-launcher-cli")):
            filehandle, _ = urllib.urlretrieve(self.url)
            if self.system == "linux":
                with tarfile.open(filehandle) as h:
                    h.extractall(self.filePath)
            else:
                with zipfile.ZipFile(filehandle, "r") as h:
                    h.extractall(self.filePath)

    def setSettings(self, settings_file):
        self._settings = json.load(open(settings_file, "r"))

    def startBenchmark(self):
        self.getSettings(("blender","download"))
        self.getSettings(("scenes","download"))
        self.scenes = " ".join([str(elem) for elem in self._settings["scenes"]])
        try:
            startBench = subprocess.run(
                [
                    os.path.join(self.filePath, self.baseCommand),
                    "benchmark",
                    str(self.scenes),
                    "-b",
                    str(self._settings["blender_version"]),
                    "--device-type",
                    str(self._settings["device_type"]),
                    "--json",
                ]
            )
        except subprocess.CalledProcessError as e:
            print(e.output)
            exit
        if startBench.returncode != 0:
            raise startBench.stderr

    def benchmarkStatus():
        pass

    def getSettings(self, args):
        commands = {
            "blender": {
                "download": [                                               # Downloads the blender version specified in the settings
                    os.path.join(self.filePath, self.baseCommand),
                    "blender",
                    "download",
                    str(self._settings["blender_version"]),
                ],
                "list": [                                                    # Lists available blender versions
                    os.path.join(self.filePath, self.baseCommand),
                    "blender",
                    "list",
                ],
            },
            "compatible_devices": [                                          # Prints compatible devices, TODO: Filter GPU devices from other devices
                os.path.join(self.filePath, self.baseCommand),
                "devices",
                "-b",
                str(self._settings["blender_version"]),
            ],
            "help": [
                os.path.join(self.filePath, self.baseCommand),
                "--help",
            ],                                                               # Prints the help window
            "scenes": {
                "download": [                                                   # Downloads the scenes mentioned in settings
                    os.path.join(self.filePath, self.baseCommand),
                    "scenes",
                    "download",
                    "-b",
                    str(self._settings["blender_version"]),
                ]
                + (self._settings["scenes"]),
                "list": [  # Lists scenes
                    os.path.join(self.filePath, self.baseCommand),
                    "scenes",
                    "list",
                    "-b",
                    str(self._settings["blender_version"]),
                ],
            },
            "clear_cache": [  # Clears cache generated by the blender cli
                os.path.join(self.filePath, self.baseCommand),
                "clear_cache",
            ],
        }
        if len(args) == 2:
            command = commands.get(args[0]).get(args[1])
        elif len(args) == 1:
            command = commands.get(args[0])
        else:
            raise Exception("Please check your command and enter again")
        try:
            process = subprocess.run(command, check=True, universal_newlines=True)
        except subprocess.CalledProcessError as e:
            print(e.output)
        if process.returncode != 0:
            raise process.stderr

    def stopBenchmark():
        pass
